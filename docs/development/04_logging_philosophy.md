# 日志分级哲学

## 核心原则

### 日志的战略意义

日志不仅仅是调试工具，更是：

- **系统健康监控**的眼睛
- **用户体验问题**的放大镜  
- **性能优化**的指南针
- **故障排查**的导航仪

### 设计哲学

> **"日志应该是故事，不是噪音。每条日志都应该有其存在的价值和目的。"**

## 分级标准

### DEBUG 级别

**用途**: 详细的执行流程，用于开发调试

**使用场景**:

- 函数入参和返回值
- 循环和条件分支细节
- 临时调试信息

**示例**:

```typescript
console.debug('[PureSubs Debug] 🔍 Function extractSubtitles called with:', { 
  url, 
  options,
  timestamp: Date.now()
});

console.debug('[PureSubs Debug] 📊 Processing subtitle track:', {
  language: track.language,
  isAutoGenerated: track.isAutoGenerated,
  baseUrl: track.baseUrl.substring(0, 50) + '...'
});
```

**输出控制**:

```typescript
// 仅在开发环境输出
if (process.env.NODE_ENV === 'development') {
  console.debug('[Debug]', data);
}
```

### INFO 级别  

**用途**: 关键状态变化和正常操作流程

**使用场景**:

- 系统初始化完成
- 关键操作成功执行
- 状态转换通知
- 用户操作确认

**示例**:

```typescript
console.info('[PureSubs] ✅ Spy script ready, button enabled');
console.info('[PureSubs] 🎯 Subtitle extraction started for video:', videoId);
console.info('[PureSubs] 📥 Downloaded subtitles:', {
  language: 'zh-Hans',
  format: 'SRT',
  entriesCount: 156
});
```

### WARN 级别

**用途**: 可恢复的问题和需要注意的异常情况

**使用场景**:

- 降级策略启用
- 配置问题提醒
- 性能警告
- 不完美但可继续的状态

**示例**:

```typescript
console.warn('[PureSubs] ⚠️ Primary language not found, falling back to:', fallbackLang);
console.warn('[PureSubs] ⚠️ Network slow, subtitle loading may take longer');
console.warn('[PureSubs] ⚠️ Chrome storage quota approaching limit:', usagePercent + '%');
```

### ERROR 级别

**用途**: 需要处理的错误和异常

**使用场景**:

- 功能完全失败
- 网络错误
- 数据解析错误
- 用户需要感知的问题

**示例**:

```typescript
console.error('[PureSubs] ❌ Subtitle extraction failed:', {
  error: error.message,
  videoId,
  retryCount,
  stack: error.stack
});

console.error('[PureSubs] ❌ Network request failed:', {
  url: request.url,
  status: response.status,
  statusText: response.statusText
});
```

## 上下文增强

### 结构化日志

```typescript
interface LogContext {
  component: string;      // 'content-script' | 'background' | 'spy-script'
  action: string;         // 'extract' | 'parse' | 'download'
  videoId?: string;
  userId?: string;
  sessionId: string;
  timestamp: number;
}

class Logger {
  constructor(private context: LogContext) {}
  
  info(message: string, data?: any): void {
    console.info(`[${this.context.component}] ${message}`, {
      ...this.context,
      data,
      timestamp: Date.now()
    });
  }
}
```

### 组件标识

```typescript
// 内容脚本日志
console.log('[PureSubs Content] 🎯 Button injection started');

// 后台脚本日志  
console.log('[PureSubs Background] 🔄 Tab switch detected');

// 间谍脚本日志
console.log('[PureSubs Spy] 🕵️ Network request intercepted');

// 核心引擎日志
console.log('[PureSubs Core] ⚙️ Parsing subtitle XML');
```

### 生命周期追踪

```typescript
// 操作开始
console.info('[PureSubs] 🚀 Subtitle extraction lifecycle started', {
  videoId,
  requestId: generateRequestId(),
  userAgent: navigator.userAgent
});

// 关键步骤
console.info('[PureSubs] 📡 Network interception setup complete');
console.info('[PureSubs] 🔍 Subtitle tracks discovered:', trackCount);
console.info('[PureSubs] 📝 Content parsing in progress');

// 操作完成
console.info('[PureSubs] ✅ Subtitle extraction lifecycle completed', {
  duration: Date.now() - startTime,
  resultSize: result.subtitles?.srt.length,
  success: true
});
```

## 性能监控集成

### 关键指标记录

```typescript
interface PerformanceMetrics {
  extractionDuration: number;
  networkRequests: number;
  cacheHits: number;
  memoryUsage: number;
}

class PerformanceLogger {
  private metrics: PerformanceMetrics = {
    extractionDuration: 0,
    networkRequests: 0,
    cacheHits: 0,
    memoryUsage: 0
  };
  
  logPerformance(operation: string, duration: number): void {
    console.info(`[PureSubs Performance] 📊 ${operation}:`, {
      duration: `${duration}ms`,
      memory: this.getMemoryUsage(),
      timestamp: Date.now()
    });
  }
  
  private getMemoryUsage(): string {
    if ('memory' in performance) {
      const mem = (performance as any).memory;
      return `${Math.round(mem.usedJSHeapSize / 1024 / 1024)}MB`;
    }
    return 'N/A';
  }
}
```

### 用户行为追踪

```typescript
// 用户交互日志
console.info('[PureSubs User] 👆 Button clicked', {
  buttonState: 'ready',
  videoId,
  userSettings: getUserPreferences()
});

console.info('[PureSubs User] ⚙️ Settings changed', {
  previousLang: 'en',
  newLang: 'zh-Hans',
  autoDownload: true
});
```

## 错误处理最佳实践

### 错误上下文收集

```typescript
class ErrorCollector {
  static captureError(error: Error, context: any): void {
    const errorReport = {
      message: error.message,
      stack: error.stack,
      context,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      url: window.location.href
    };
    
    console.error('[PureSubs Error] 💥 Captured error:', errorReport);
    
    // 发送到错误监控服务（可选）
    if (process.env.NODE_ENV === 'production') {
      this.sendErrorReport(errorReport);
    }
  }
}

// 使用示例
try {
  const result = await extractSubtitles(url);
} catch (error) {
  ErrorCollector.captureError(error, {
    operation: 'extractSubtitles',
    url,
    options,
    retryCount
  });
}
```

### 用户友好错误

```typescript
// 技术错误 -> 用户友好信息
const ErrorMessages = {
  NETWORK_ERROR: '网络连接问题，请检查网络设置',
  NO_SUBTITLES: '该视频暂无字幕，请尝试其他视频',
  PARSE_ERROR: '字幕格式解析失败，请联系开发者',
  TIMEOUT: '获取字幕超时，请稍后重试'
};

function logUserError(errorCode: string, technicalDetails: any): void {
  // 技术日志
  console.error('[PureSubs Technical]', technicalDetails);
  
  // 用户通知
  console.info('[PureSubs User] 💬 User message:', ErrorMessages[errorCode]);
}
```

## 调试工具集成

### 开发者调试面板

```typescript
// 开发环境专用调试工具
if (process.env.NODE_ENV === 'development') {
  (window as any).PureSubsDebug = {
    enableVerboseLogging: () => {
      localStorage.setItem('puresubs_debug', 'true');
      location.reload();
    },
    
    exportLogs: () => {
      const logs = JSON.stringify(this.logHistory, null, 2);
      const blob = new Blob([logs], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `puresubs-logs-${Date.now()}.json`;
      a.click();
    },
    
    clearCache: () => {
      chrome.storage.local.clear();
      console.info('[PureSubs Debug] 🗑️ Cache cleared');
    }
  };
}
```

### 动态日志级别控制

```typescript
class LogLevel {
  private static currentLevel = 'INFO';
  
  static setLevel(level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR'): void {
    this.currentLevel = level;
    localStorage.setItem('puresubs_log_level', level);
    console.info(`[PureSubs] 📊 Log level set to: ${level}`);
  }
  
  static shouldLog(level: string): boolean {
    const levels = ['DEBUG', 'INFO', 'WARN', 'ERROR'];
    const currentIndex = levels.indexOf(this.currentLevel);
    const messageIndex = levels.indexOf(level);
    return messageIndex >= currentIndex;
  }
}
```

## 生产环境优化

### 日志收集策略

```typescript
// 生产环境日志配置
const ProductionLogger = {
  // 只保留关键日志
  info: (message: string, data?: any) => {
    if (this.isKeyMessage(message)) {
      console.info(message, data);
    }
  },
  
  warn: console.warn.bind(console),
  error: console.error.bind(console),
  
  // 禁用调试日志
  debug: () => {},
  
  isKeyMessage: (message: string): boolean => {
    const keyPatterns = [
      'extraction completed',
      'user interaction',
      'performance metrics',
      'error occurred'
    ];
    return keyPatterns.some(pattern => message.includes(pattern));
  }
};
```

### 用户反馈集成

```typescript
// 用户遇到问题时的日志导出
function generateSupportPackage(): string {
  const supportData = {
    version: chrome.runtime.getManifest().version,
    userAgent: navigator.userAgent,
    recentLogs: this.getRecentLogs(100),
    settings: getUserPreferences(),
    timestamp: Date.now()
  };
  
  return JSON.stringify(supportData, null, 2);
}
```

## 日志分析与监控

### 关键指标定义

```typescript
interface LogMetrics {
  successRate: number;           // 成功率
  averageExtractionTime: number; // 平均提取时间
  errorFrequency: number;        // 错误频率
  cacheHitRate: number;          // 缓存命中率
  userSatisfaction: number;      // 用户满意度
}

class LogAnalyzer {
  analyzeUserExperience(logs: LogEntry[]): UserExperienceReport {
    // 分析日志，生成用户体验报告
  }
}
```

---

*"优秀的日志是无声的导师，教会我们系统的每一个细节。"*  
*— PureSubs 日志哲学*
